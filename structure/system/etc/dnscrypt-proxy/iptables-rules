################################
#        Iptables rules        #
################################

IPTABLES=/system/bin/iptables
WIFI_INT="wlan0"
PROXY_PORT=5353

do_iptables_rules () {
	case "$1" in
		0) #enable
			enable_rules
			;;
			
		1) #disable
			disable_rules
			;;
			
	esac
}

enable_rules () {
	disable_rules
	$IPTABLES -t nat -A OUTPUT -p tcp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
	$IPTABLES -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
}

disable_rules () {
	IPC=( "tcp" "udp" )
	
	for i in "${IPC[@]}" ; do
		while $IPTABLES -n -t nat -L OUTPUT | grep -q "DNAT.*$i.*dpt:53.*to:127.0.0.1:$PROXY_PORT" ; do
			$IPTABLES -t nat -D OUTPUT -p $i --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
		done
	done
}

ipv4_addr_lock () {
	$IPTABLES -P INPUT DROP
	$IPTABLES -P OUTPUT DROP
	$IPTABLES -P FORWARD DROP
	$IPTABLES -F mreject
	$IPTABLES -N mreject
	$IPTABLES -A mreject -j DROP
	$IPTABLES -L INPUT | grep -q 'mreject' || $IPTABLES -I INPUT 1 -j "mreject"
	$IPTABLES -L OUTPUT | grep -q 'mreject' || $IPTABLES -I OUTPUT 1 -j "mreject"
	$IPTABLES -L FORWARD | grep -q 'mreject' || $IPTABLES -I FORWARD 1 -j "mreject"
	echo "1" > /proc/sys/net/ipv4/conf/all/disable_policy
	echo "1" > /proc/sys/net/ipv4/conf/default/disable_policy
	if [ -d /proc/sys/net/ipv4/conf/$WIFI_INT ]; then
		echo "1" > /proc/sys/net/ipv4/conf/$WIFI_INT/disable_policy
	fi;
}

ipv4_addr_unlock () {
	$IPTABLES -P INPUT ACCEPT
	$IPTABLES -P OUTPUT ACCEPT
	$IPTABLES -P FORWARD DROP
	$IPTABLES -L INPUT | grep -q 'mreject' && $IPTABLES -D INPUT -j "mreject"
	$IPTABLES -L OUTPUT | grep -q 'mreject' && $IPTABLES -D OUTPUT -j "mreject"
	$IPTABLES -L FORWARD | grep -q 'afwall-reject' || $IPTABLES -A FORWARD -j "afwall-reject"
	$IPTABLES -L FORWARD | grep -q 'mreject' && $IPTABLES -D FORWARD -j "mreject"
	$IPTABLES -F mreject
	$IPTABLES -X mreject
	echo "0" > /proc/sys/net/ipv4/conf/all/disable_policy
	echo "0" > /proc/sys/net/ipv4/conf/default/disable_policy
	if [ -d /proc/sys/net/ipv4/conf/$WIFI_INT ]; then
		echo "0" > /proc/sys/net/ipv4/conf/$WIFI_INT/disable_policy;
	fi;
}
