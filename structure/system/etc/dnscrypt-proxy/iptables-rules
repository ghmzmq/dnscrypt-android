################################
#        Iptables rules        #
################################

IPTABLES=/system/bin/iptables
WIFI_INT="wlan0"
PROXY_PORT=5353

do_iptables_rules () {
	case "$1" in
		0) # enable
			enable_rules
			;;
		1) # disable
			disable_rules
			;;
	esac
}

enable_rules () {
	disable_rules
	$IPTABLES -t nat -A OUTPUT -p tcp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
	$IPTABLES -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
}

disable_rules () {
	IPvX=( "$IPTABLES" )
	
	for ipt in "${IPvX[@]}" ; do
		while $ipt -n -t nat -L OUTPUT | grep -q "DNAT.*tcp.*dpt:53.*to:127.0.0.1:$PROXY_PORT" ; do
			$ipt -t nat -D OUTPUT -p tcp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
		done
		while $ipt -n -t nat -L OUTPUT | grep -q "DNAT.*udp.*dpt:53.*to:127.0.0.1:$PROXY_PORT" ; do
			$ipt -t nat -D OUTPUT -p udp --dport 53 -j DNAT --to-destination 127.0.0.1:$PROXY_PORT
		done
	done
}

ipv4_addr_lock () {
	$IPTABLES -P INPUT DROP
	$IPTABLES -P OUTPUT DROP
	$IPTABLES -P FORWARD DROP
	echo "1" > /proc/sys/net/ipv4/conf/all/disable_policy
	echo "1" > /proc/sys/net/ipv4/conf/default/disable_policy
	if [ -d /proc/sys/net/ipv4/conf/$WIFI_INT ]; then
		echo "1" > /proc/sys/net/ipv4/conf/$WIFI_INT/disable_policy
	fi
}

ipv4_addr_unlock () {
	$IPTABLES -P INPUT ACCEPT
	$IPTABLES -P OUTPUT ACCEPT
	$IPTABLES -P FORWARD ACCEPT
	echo "0" > /proc/sys/net/ipv4/conf/all/disable_policy
	echo "0" > /proc/sys/net/ipv4/conf/default/disable_policy
	if [ -d /proc/sys/net/ipv4/conf/$WIFI_INT ]; then
		echo "0" > /proc/sys/net/ipv4/conf/$WIFI_INT/disable_policy
	fi
}
